var x$;x$=angular.module("stockings",[]),x$.service("stocks",["$rootScope"].concat(function(t){var o,r,n;return o={stocks:{},consumed:{},remains:{},options:{},choices:{}},r=function(){function t(){var t,r,n=[];for(t=0,r=o.remains[e].quantity[c];r>=t;++t)f=t,n.push({count:f});return n}var r,n,s,e,i,c,u,a,h,l,f,m=[];o.remains=JSON.parse(JSON.stringify(o.stocks));for(r in n=o.consumed){s=n[r];for(e in s){i=s[e];for(c in i)u=i[c],((a=o.remains)[e]||(a[e]={})).quantity[c]=(((a=(h=o.remains)[e]||(h[e]={})).quantity||(a.quantity={}))[c]||0)-u,((a=(h=o.remains)[e]||(h[e]={})).quantity||(a.quantity={}))[c]<0&&(o.remains[e].quantity[c]=0)}}for(e in n=o.stocks){s=n[e],l=[],o.options[e]={},o.choices[e]={};for(c in s.quantity)o.options[e][c]=t(),l.push(o.choices[e][c]?o.choices[e][c].count<o.options[e][c].length?o.choices[e][c]=o.options[e][c][o.choices[e][c]].count:o.choices[e][c]=(a=o.options[e][c])[a.length-1]:o.choices[e][c]=o.options[e][c][0]);m.push(l)}return m},n={stocks:new Firebase("https://stockings-2f825.firebaseio.com/stocks"),consumed:new Firebase("https://stockings-2f825.firebaseio.com/consumed")},n.stocks.on("value",function(n){return setTimeout(function(){return t.$apply(function(){return o.stocks=n.val()||{},r()})},0)}),n.consumed.on("value",function(n){return setTimeout(function(){return t.$apply(function(){return o.consumed=n.val()||{},r()})},0)}),o})),x$.controller("form",["$scope","stocks"].concat(function(t,o){var r;return t.stocks=o,t.ctrl={},r={orders:new Firebase("https://stockings-2f825.firebaseio.com/orders"),consumed:new Firebase("https://stockings-2f825.firebaseio.com/consumed")},t.form={init:function(){var o=this;return this.reset(),t.$watch("stocks.choices",function(){var r,n,s,e,i;r=t.stocks.choices,o.order=[],o.subtotal=0,o.amount=0;for(n in r){s=r[n];for(e in s)i=s[e],i.count&&(o.order.push({stockid:n,variant:e,quantity:i.count}),o.amount+=i.count,o.subtotal+=i.count*t.stocks.stocks[n].price[e])}return o.subtotal&&(o.subtotal+=60),t.form.check()},!0)},reset:function(o){var r;return null==o&&(o=!1),this.slot=0,this.name="",this.phone="",this.addr="",this.order=[],this.amount=0,this.subtotal=0,this.error=null,r=t.ctrl,r.loading=!1,r.done=!1,r.checking=!1,o?smoothScroll.animateScroll(document.querySelector("#a-form")):void 0},check:function(){return t.ctrl.checking?(this.error=null,this.name||((this.error||(this.error={})).name="必填"),this.phone||((this.error||(this.error={})).phone="必填"),this.addr||((this.error||(this.error={})).addr="必填"),this.subtotal?void 0:(this.error||(this.error={})).subtotal="您尚未選取商品"):void 0},submit:function(){var o,n,s,e,i,c,u;if(t.ctrl.checking=!0,this.check(),!this.error){for(o=t.ctrl,o.checking=!1,o.loading=!0,n=angular.fromJson(angular.toJson({name:(o=t.form).name,phone:o.phone,addr:o.addr,subtotal:o.subtotal,amount:o.amount,order:o.order})),s={},e=0,i=(o=this.order).length;i>e;++e)c=o[e],(s[u=c.stockid]||(s[u]={}))[c.variant]=c.quantity;return r.consumed.push(s,function(){return r.orders.push(n,function(){return t.$apply(function(){var o;return o=t.ctrl,o.loading=!1,o.done=!0,o.checking=!1,o}),fbq("track","Purchase",{value:t.form.subtotal+"",currency:"TWD"})})})}}},t.form.init()}));